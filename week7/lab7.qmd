---
title: "Lab 7"
subtitle: "The Color of Drinking Water"
toc: true
editor: visual
format:
  html:
    other-links:
      - text: Download Source
        href: lab7.qmd
      - text: Drinking Water Data
        href: data/drinking_water.csv
editor_options: 
  chunk_output_type: console
---

## Learning objectives

In today's lab you will...

1.  Fit **logistic regression** models to binary (0/1, no/yes) outcomes
2.  Interpret **coefficients**
3.  **Visualize** predictions

Complete sections **Logistic model notation and R code** and **Read and explore the data** before class.

```{r}
#| label: setup
#| message: false
#| warning: false

library(tidyverse)
theme_set(theme_classic(12))
set.seed(123)


library(ggplot2)
library(patchwork)
```

## Logistic model notation and R code

``` r

logistic_model <- glm(violation ~ PctHisp,
                      data = my_data,
                      family = binomial(link = "logit"))
```

In statistical notation, logistic models take the form:

$$
\begin{align}
\text{BinaryOutcome} &\sim Binomial(1, p) \\
logit(p) &= \beta_0 + \beta_1 \text{Predictor}
\end{align}
$$

In R, you can fit a logistic model like this:

``` r
logistic_model <- glm(binary_outcome ~ predictor,
                      data = my_data,
                      family = binomial(link = "logit"))
```

**In both the notation and code above, identify the:**

-   **Response family**

    -   Binomial

-   **Link function**

    -   logit(p) = log ( p / ( 1 - p ) )

        -   p = logit\^(-1) \* ( logit(p) )

-   **Response**

    -   Binary outcomes

-   **Predictor**

    -   Binomial / predictor

## Read and explore the data

**Read the dataset in drinking_water.csv.**

```{r}
#| label: read-data

drinking_water <- read_csv(here::here('week7', 'data', 'drinking_water.csv'))

head(drinking_water)
```

**Describe what you think each of the columns represents.**

| Column              | Meaning                                             |
|---------------------|-----------------------------------------------------|
| `pwsid`             | Public Water system ID                              |
| `pwsname`           | Name                                                |
| `pctpov`            | percent under the poverty line                      |
| `pcthisp`           | percent hispanic                                    |
| `health`            | Number of health violations                         |
| `medianincomehouse` | Median income                                       |
| `violation`         | had or did not have violations - TRUE v FALSE       |
| `pcthisp_bin`       | All similar percent hispanic values that are binned |
| `pctpov_bin`        |                                                     |

$$
\begin{align}
\text{violation} &\sim Binomial(1, p) \\
logit(p) &= \beta_0 + \beta_1 \text{PctHisp}
\end{align}
$$

**Create three figures summarizing the relationships between race, class, and SDWA violations.**

Figure 1: A scatter plot showing the *proportion* of districts with SDWA violations in each *percent Hispanic bin*.

Figure 2: A scatter plot showing the *proportion* of districts with SDWA violations in each *percent below-poverty bin*.

Figure 3: A scatter plot showing the correlation between *percent Hispanic* and *percent below-poverty* at the district level.

```{r}
#| label: fig-explore
# Figure 1:  A scatter plot showing the proportion of districts with SDWA violations in each percent Hispanic bin.


drinking_water %>% 
  group_by(pcthisp) %>% 
  mutate(prop_violation = mean(violation)) %>% 
  ggplot(aes(pcthisp_bin, prop_violation)) + 
  geom_point()


drinking_water %>% 
  group_by(pctpov) %>% 
  mutate(prop_violation = mean(violation)) %>% 
  ggplot(aes(pctpov_bin, prop_violation)) + 
  geom_point()




figure1 <- ggplot(drinking_water, 
       aes(x = pcthisp_bin, 
           y = health)) + 
  geom_jitter(alpha = 0.5, 
              color = "steelblue") + 
  labs(x = "% Hispanic Bins", 
       y = "Health Violations", 
       title = "Figure 1") + 
  theme_bw()
figure1 


# Figure 2: A scatter plot showing the proportion of districts with SDWA violations in each percent below-poverty bin.
figure2 <- ggplot(drinking_water, 
       aes(x = pctpov_bin, 
           y = health)) + 
  geom_jitter(alpha = 0.5, 
              color = "maroon4") + 
  labs(x = "% Poverty Bins", 
       y = "Health Violations", 
       title = "Figure 2") + 
  theme_bw()
figure2 


# Figure 3 : A scatter plot showing the correlation between percent Hispanic and percent below-poverty at the district level.
figure3 <- ggplot(drinking_water, 
       aes(x = pcthisp, 
           y = pctpov)) + 
  geom_jitter(alpha = 0.5, 
              color = "forestgreen") + 
  labs(x = "% Hispanic", 
       y = "% Below the Poverity Line", 
       title = "Figure 3") + 
  theme_bw()
figure3

(figure1 | figure2 | figure3)
```

## Fit and interpret model

Our question is:

*How are SDWA violations distributed among communities by class and race?*

Let's begin by investigating class in isolation. **Fit a logistic model to see how `violation` responds to `pctpov`**.

$$
\begin{align}
\text{violation} &\sim Binomial(1, p) \\
logit(p) &= \beta_0 + \beta_1 \text{PctPov}
\end{align}
$$

```{r}
#| label: fit-model-class
class_model <- glm(violation ~ pctpov, # formular reponse ~ predictor
                   data = drinking_water, # data remains unchanged
                   family = binomial(link = "logit")) # family and link 

class_sum <- summary(class_model)

```

Just as we did with linear regression, you can inspect coefficient estimates, p-values, and confidence intervals using `summary()` and `confint()`.

**What is the best estimate for the % Below Poverty coefficient?**

```{r}
coef(class_model)
coef(class_model)["pctpov"]
```

**Is the coefficient significantly different than 0? Assume critical threshold of 0.05.**

```{r}
# Same thing: 
class_sum$coefficients[2,4]
class_sum$coefficients["pctpov",4]
```

**What is the 95% CI for the coefficient?**

```{r}
confint(class_model)
confint(class_model)["pctpov", ] # Just the B1 row 
```

**Based on the sign, what is the relationship between class and SDWA violations?**

Sign is positive, so a positive association between the two

## Make predictions

Interpreting the coefficients directly is pretty difficult with logistic regression! What is the difference between a coefficient of 0.1 and 0.2? Rather than interpreting the coefficient directly, it's often easier to compare predictions.

Once you have a model, you can make predictions using `predict()`. When calling `predict()`, the following parameters are important:

-   `object` The model you want to generate predictions from

-   `newdata` A data frame of predictors your want predictions for

-   `type` Do you want predictions on the *link* or *response* scale? By default, `predict()` shows the value of $logit(p) = \beta_0 + \beta_1 x$ (i.e., link-scale). To get the predicted *probability* (i.e., response-scale) set `type` to "response".

-   `se.fit` If `se.fit` is `TRUE`, `predict()` will calculate the confidence interval of the response on the link scale. You can use that to get the confidence interval of $p$. That will make a ribbon, similar to the confidence interval of $\mu$ you saw in linear regression.

Here's how to generate predictions (with CI) for a single predictor.

::: callout-tip
I use `expand_grid()` instead of `tibble()` when making the data frame of predictors because it gives you every combination of the values in the columns. That will be important when you have more than one predictor!
:::

```{r}
#| label: predict-class-model

# A grid of predictors to generate prediction for 
pred_grid <- expand_grid(pctpov = 0:100) # expand_grid - like tibble


# Gerneate our predictions (added a p value to our dataframe)
class_mod_pred <- pred_grid %>% 
  mutate(p = predict(object = class_model,  # Use this model 
                          newdata = pred_grid,  # Use these values 
                          type = "response")) # response = looking at p; link = logit of p 


```

```{r}
#| label: plot-class-best-estimate

ggplot(class_mod_pred,
       aes(x = pctpov, 
           y = p)) + 
  geom_line() + 
  ylim(0,1)
  

```

That was just the best estimate. The following code adds the 95% CI for $p$. It uses the *inverse link function* to go from link-scale to response-scale.

::: callout-caution
When constructing the 95% CI for $p$, one thing remains the same and one thing has changed from constructing the 95% CI for $\mu$.

**What remains the same:** the sampling distribution is normal, so once you have the standard error you can use `qnorm()` to get the 2.5% and 97.5% quantiles.

**What's different:** the sampling distribution exists on the *link scale*. In other words, the standard error is $SE(logit(p))$ rather than $SE(p)$. So you have to get the best estimate and standard error on the link scale, then invert the link function to get back to $p$.
:::

```{r}
#| label: predict-class-model-ci

# STANDARD ERROR for class model 
class_model_se <- predict(object = class_model, 
                          newdata = pred_grid, 
                          type = "link", 
                          se.fit = TRUE)

# Go from link to response spaces ... logit(p) --> p
linkinv <- family(class_model)$linkinv 

linkinv(0)

class_mod_pred <- pred_grid %>% 
  mutate(
    # get logit(p)
    logit_p = class_model_se$fit,
    # 95% CI in link space 
    logit_p_se = class_model_se$se.fit, 
    logit_p_lwr = qnorm(0.025, mean = logit_p, sd = logit_p_se),
    logit_p_upr = qnorm(0.975, mean = logit_p, sd = logit_p_se), 
    
    p = linkinv(logit_p),
    p_lwr = linkinv(logit_p_lwr), 
    p_upr = linkinv(logit_p_upr)
  )
```

And here's the fit with the 95% CI presented as the familiar ribbon.

```{r}
#| label: plot-class-ci

ggplot(class_mod_pred, 
       aes(x = pctpov, 
           y = p)) + 
  geom_ribbon(aes(ymin = p_lwr, ymax = p_upr),
              alpha = 0.2) + 
  geom_line()

```

**What is the probability of a SDWA violation in a district where 5% of households are below the poverty line? When 50% are? Show the best estimate and 95% CI.**

```{r}
#| label: class-estimate-ci



```

## Your turn

Switzer and Teodoro demonstrated that the *interaction* between race and class is important for understanding the environmental justice dimensions of drinking water. You'll investigate that here through the following steps.

1.  Create a new model with an interaction term between `pctpov` and `pcthisp`.
2.  Use the summary and confidence intervals to answer the following questions:\
    **What is the 95% CI for the % Hispanic coefficient?**\
    **Is the interaction between class and race significantly different than 0?**
3.  Create a new predictor data frame with combinations of *both* predictors.
4.  Generate predictions, including both the best estimate and 95% CI.
5.  Plot the predictions. In your plot, put `pcthisp` on the x-axis and probability of SDWA violations on the y-axis. Indicate `pctpov` using color and fill. To make this work, you'll have to filter your predictions to a few levels of `pctpov` (e.g., 0, 25, 50, and 75).

```{r}
#| label: your-turn

# Create new fit model

inter_model <- glm(violation ~ pctpov * pcthisp, # formular reponse ~ predictor
                   data = drinking_water, # data remains unchanged
                   family = binomial(link = "logit")) # family and link 


inter_sum <- summary(inter_model)

# Pull Coeffients out 
coef(inter_model)["pctpov"]
coef(inter_model)["pcthisp"]

# P values 
inter_sum$coefficients["pctpov", 4]
inter_sum$coefficients["pcthisp", 4]

# CIs 
confint(inter_model)["pctpov", ]
confint(inter_model)["pcthisp", ]
```

Make Predictions

```{r}

# A grid of predictors to generate prediction for 
inter_grid <- expand_grid(pctpov = 0:100, 
                          pcthisp = 0:100) # expand_grid - like tibble


# Gerneate our predictions (added a p value to our dataframe)
inter_mod_pred <- inter_grid %>% 
  mutate(p = predict(object = inter_model,  # Use this model 
                          newdata = inter_grid,  # Use these values 
                          type = "response")) # response = looking at p; link = logit of p 


# Plot ? 
# p with pct pov 
ggplot(inter_mod_pred,
       aes(x = pctpov, 
           y = p)) + 
  geom_line() + 
  ylim(0,1)

# p with pct hispanic 
ggplot(inter_mod_pred,
       aes(x = pcthisp, 
           y = p)) + 
  geom_line() + 
  ylim(0,1)

```

```{r}

# STANDARD ERROR for class model 
inter_model_se <- predict(object = inter_model, 
                          newdata = inter_grid, 
                          type = "link", 
                          se.fit = TRUE)

# Go from link to response spaces ... logit(p) --> p
linkinv <- family(inter_model)$linkinv 

linkinv(0)

# Creating a prediction model with logit(p), p, nd upper + lower CIs for logit and p 
inter_mod_pred <- inter_grid %>% 
  mutate(
    # get logit(p)
    logit_p = inter_model_se$fit,
    # 95% CI in link space 
    logit_p_se = inter_model_se$se.fit, 
    logit_p_lwr = qnorm(0.025, mean = logit_p, sd = logit_p_se),
    logit_p_upr = qnorm(0.975, mean = logit_p, sd = logit_p_se), 
    
    p = linkinv(logit_p),
    p_lwr = linkinv(logit_p_lwr), 
    p_upr = linkinv(logit_p_upr)
  )


# plot! 

# Filter your predictions to a few levels of pctpov (e.g., 0, 25, 50, and 75).
# pcthisp on the x-axis and probability of SDWA violations on the y-axis
# pctpov using color and fill.

inter_mod_pred %>% 
  filter()

ggplot(inter_mod_pred, 
       aes(x = pcthisp, 
           y = p)) + 
  geom_ribbon(aes(ymin = p_lwr, ymax = p_upr),
              alpha = 0.2) + 
  geom_line(aes(color = pctpov))
```

The coefficient for an interaction term in a logistic regression model is very difficult to interpret on its own! But that value has important consequences for the lives of millions of people. Predictions are usually more straightforward to interpret than coefficients. Use your figure and the outputs of `summary()` and `confint()` to reflect on the following prompt. Reply to the corresponding thread on Slack with your reflection to get 1 token.

**In plain language, what is the relationship between race, class, and SDWA violations? Which communities face the greatest risks associated with drinking water? How would you use the statistical outputs (model summary, prediction figure) to describe that risk quantitatively? How could those statistical outputs be misinterpreted?**
